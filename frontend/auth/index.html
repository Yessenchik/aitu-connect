<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AITU Connect â€” Auth</title>
  <style>
    body { font-family: system-ui, -apple-system, Arial; padding: 40px; max-width: 560px; margin: 0 auto; }
    h1 { margin-bottom: 10px; }
    .tabs { display: flex; gap: 10px; margin: 16px 0; }
    .tab { padding: 10px 14px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    .tab.active { background: #fff; border-bottom-color: #fff; font-weight: 600; }
    .panel { border: 1px solid #ccc; padding: 16px; background: #fff; }
    label { display:block; margin-top: 12px; }
    input, textarea, select { width: 100%; padding: 10px; margin-top: 6px; box-sizing: border-box; }
    button { margin-top: 16px; padding: 10px 14px; cursor: pointer; width: 100%; }
    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }
    .msg { margin-top: 12px; }
    .err { color: #b00020; }
    .ok  { color: #0a7a2f; }
    .hint { color: #666; font-size: 14px; margin-top: 6px; }
  </style>
</head>
<body>
<h1>AITU Connect</h1>
<div class="hint">Use your AITU email like <b>241415@astanait.edu.kz</b></div>

<div class="tabs">
  <button id="tabLogin" class="tab active" type="button">Sign In</button>
  <button id="tabRegister" class="tab" type="button">Sign Up</button>
</div>

<div class="panel">
  <!-- LOGIN -->
  <form id="loginForm">
    <h2 style="margin-top:0">Sign In</h2>

    <label>
      Email
      <input id="loginEmail" autocomplete="email" placeholder="241415@astanait.edu.kz" required />
    </label>

    <label>
      Password
      <input id="loginPassword" type="password" autocomplete="current-password" required />
    </label>

    <button id="loginBtn" type="submit">Login</button>
    <p id="loginMsg" class="msg"></p>
  </form>

  <!-- REGISTER -->
  <form id="registerForm" style="display:none">
    <h2 style="margin-top:0">Sign Up</h2>

    <label>
      Email
      <input id="regEmail" autocomplete="email" placeholder="241415@astanait.edu.kz" required />
    </label>

    <label>
      Password (min 8)
      <input id="regPassword" type="password" autocomplete="new-password" required />
    </label>

    <div class="row">
      <div>
        <label>
          First name
          <input id="firstName" autocomplete="given-name" required />
        </label>
      </div>
      <div>
        <label>
          Last name
          <input id="lastName" autocomplete="family-name" required />
        </label>
      </div>
    </div>

    <label>
      Bio (optional)
      <textarea id="bio" rows="3" placeholder="Tell something about yourself..."></textarea>
    </label>

    <label>
      Role
      <select id="role">
        <option value="student" selected>student</option>
        <option value="teacher">teacher</option>
        <option value="admin">admin</option>
      </select>
    </label>

    <button id="regBtn" type="submit">Create account</button>
    <p id="regMsg" class="msg"></p>
  </form>
</div>

<script>
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");

  function showLogin() {
    tabLogin.classList.add("active");
    tabRegister.classList.remove("active");
    loginForm.style.display = "block";
    registerForm.style.display = "none";
  }
  function showRegister() {
    tabRegister.classList.add("active");
    tabLogin.classList.remove("active");
    loginForm.style.display = "none";
    registerForm.style.display = "block";
  }

  tabLogin.onclick = showLogin;
  tabRegister.onclick = showRegister;

  function setMsg(el, text, ok=false) {
    el.textContent = text;
    el.className = "msg " + (ok ? "ok" : "err");
  }

  function validAituEmail(email) {
    // digits@astanait.edu.kz (4-12 digits)
    return /^\d{4,12}@astanait\.edu\.kz$/.test(email);
  }

  async function postJSON(url, bodyObj) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj),
      credentials: "include"
    });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  // LOGIN submit
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgEl = document.getElementById("loginMsg");
    const btn = document.getElementById("loginBtn");

    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    if (!validAituEmail(email)) {
      setMsg(msgEl, "Email must be like 241415@astanait.edu.kz");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Logging in...";
    setMsg(msgEl, "");

    try {
      const login = await postJSON("/api/auth/login", { email, password });
      if (!login.res.ok) throw new Error(login.data.error || "Login failed");

      setMsg(msgEl, "Success! Redirecting...", true);
      window.location.href = "/dashboard/";
    } catch (err) {
      setMsg(msgEl, err.message || "Login error");
    } finally {
      btn.disabled = false;
      btn.textContent = "Login";
    }
  });

  // REGISTER submit (then AUTO LOGIN)
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const msgEl = document.getElementById("regMsg");
    const btn = document.getElementById("regBtn");

    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value;
    const first_name = document.getElementById("firstName").value.trim();
    const last_name = document.getElementById("lastName").value.trim();
    const bio = document.getElementById("bio").value.trim();
    const role = document.getElementById("role").value;

    if (!validAituEmail(email)) {
      setMsg(msgEl, "Email must be like 241415@astanait.edu.kz");
      return;
    }
    if (password.length < 8) {
      setMsg(msgEl, "Password must be at least 8 characters");
      return;
    }
    if (!first_name || !last_name) {
      setMsg(msgEl, "First name and last name are required");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Creating account...";
    setMsg(msgEl, "");

    try {
      // 1) signup
      const signup = await postJSON("/api/auth/signup", {
        email, password, role, first_name, last_name, bio
      });
      if (!signup.res.ok) throw new Error(signup.data.error || "Signup failed");

      // 2) auto login using same credentials
      btn.textContent = "Logging in...";
      const login = await postJSON("/api/auth/login", { email, password });
      if (!login.res.ok) throw new Error(login.data.error || "Signup ok, login failed");

      setMsg(msgEl, "Success! Redirecting...", true);
      window.location.href = "/dashboard/";
    } catch (err) {
      setMsg(msgEl, err.message || "Signup error");
    } finally {
      btn.disabled = false;
      btn.textContent = "Create account";
    }
  });
</script>
</body>
</html>