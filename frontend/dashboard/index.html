<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AITU Connect — Dashboard</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --primary:#2563eb;
      --hover:#f3f4f6;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Arial; color: var(--text); background: var(--bg); }

    /* Layout */
    .layout{
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar{
      background: var(--card);
      border-right: 1px solid var(--border);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .brand h1{
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .brand small{
      color: var(--muted);
      display:block;
      margin-top: 2px;
      font-size: 12px;
    }

    .nav{
      display:flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .nav button{
      width: 100%;
      text-align:left;
      border: 1px solid var(--border);
      background: var(--card);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .nav button:hover{ background: var(--hover); }
    .nav button.active{
      border-color: rgba(37,99,235,0.35);
      background: rgba(37,99,235,0.08);
      color: var(--primary);
      font-weight: 600;
    }

    .spacer{ flex: 1; }

    .logout{
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    .logout:hover{ background: var(--hover); }

    /* Main content */
    .main{
      padding: 22px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .pageTitle{
      margin: 0;
      font-size: 22px;
    }
    .subtitle{
      margin: 6px 0 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
    }

    .hidden{ display:none; }

    /* Responsive */
    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{
        position: sticky;
        top: 0;
        z-index: 10;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .nav{
        flex-direction: row;
        flex-wrap: wrap;
      }
      .nav button{
        width: auto;
      }
    }
  </style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div>
        <h1>AITU Connect</h1>
        <small>Dashboard</small>
      </div>
    </div>

    <nav class="nav">
      <button class="tab" data-tab="posts">
        Posts <span>→</span>
      </button>
      <button class="tab" data-tab="messages">
        Messages <span>→</span>
      </button>

      <button class="tab active" data-tab="profile">
        Profile <span>→</span>
      </button>
    </nav>

    <div class="spacer"></div>

    <button id="logoutBtn" class="logout">Logout</button>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <div class="topbar">
      <div>
        <h2 id="pageTitle" class="pageTitle">Profile</h2>
        <p id="pageSubtitle" class="subtitle">Your account information and settings.</p>
      </div>
    </div>

    <!-- Panels -->
    <section id="profile" class="card panel">
      <h3 style="margin-top:0">Profile</h3>
      <div id="profileInfo" class="subtitle">Loading profile...</div>
    </section>

    <section id="messages" class="card panel hidden">
      <h3 style="margin-top:0">Messages</h3>
      <p class="subtitle">Chat UI will be here. (Later: WebSocket + conversations list)</p>
    </section>

    <section id="posts" class="card panel hidden">
      <h3 style="margin-top:0">Posts</h3>
      <p class="subtitle">Posts feed will be here. (Create post, like, comments)</p>
    </section>
  </main>

</div>

<script>
  // Tabs switching
  const tabs = document.querySelectorAll(".tab");
  const panels = document.querySelectorAll(".panel");
  const pageTitle = document.getElementById("pageTitle");
  const pageSubtitle = document.getElementById("pageSubtitle");

  const subtitles = {
    profile: "Your account information and settings.",
    messages: "Your personal and group chats.",
    posts: "News feed, posts, likes and comments."
  };

  function show(tabName) {
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === tabName));
    panels.forEach(p => p.classList.toggle("hidden", p.id !== tabName));
    pageTitle.textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
    pageSubtitle.textContent = subtitles[tabName] || "";
  }

  tabs.forEach(btn => btn.addEventListener("click", () => show(btn.dataset.tab)));

  // Logout
  document.getElementById("logoutBtn").onclick = async () => {
    await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
    window.location.href = "/auth/";
  };

  function initials(firstName, lastName) {
    const a = (firstName || "").trim().charAt(0).toUpperCase();
    const b = (lastName || "").trim().charAt(0).toUpperCase();
    return (a + b) || "??";
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;"
    }[c]));
  }

  async function loadProfile() {
    const el = document.getElementById("profileInfo");
    if (!el) return;

    const res = await fetch("/api/me", { credentials: "include" });
    if (res.status === 401) {
      window.location.href = "/auth/";
      return;
    }
    if (!res.ok) throw new Error("failed to load profile");

    const me = await res.json();

    const init = initials(me.first_name, me.last_name);
    const teamsHref =
            `https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(me.email)}`;
    const outlookHref =
            `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(me.email)}`;

    el.innerHTML = `
      <div style="display:flex; gap:16px; align-items:center;">
        <div style="
          width:64px; height:64px; border-radius:50%;
          display:flex; align-items:center; justify-content:center;
          font-weight:700; font-size:20px;
          background:#e8f0ff; color:#1d4ed8;">
          ${escapeHtml(init)}
        </div>

        <div style="display:flex; flex-direction:column; gap:6px;">
          <div style="font-size:18px; font-weight:700;">
            ${escapeHtml(me.first_name)} ${escapeHtml(me.last_name)}
          </div>

          <div style="color:#6b7280;">
            <b>barcode:</b> ${escapeHtml(me.email)}
          </div>

          <div style="display:flex; gap:12px;">
            <a href="${teamsHref}" target="_blank" rel="noreferrer">Teams</a>
            <a href="${outlookHref}" target="_blank" rel="noreferrer">Outlook</a>
          </div>
        </div>
      </div>

      <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb;" />

      <div><b>Role:</b> ${escapeHtml(me.role || "")}</div>
      <div style="margin-top:6px;">
        <b>Bio:</b> ${
            me.bio
                    ? escapeHtml(me.bio)
                    : "<span style='color:#6b7280'>empty</span>"
    }
      </div>

      <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb;" />

      <h3 style="margin:0 0 10px 0;">My posts</h3>
      <div id="myPosts" style="color:#6b7280;">(Posts will appear here after we add posts API)</div>
    `;
  }

  // Load profile on page load
  loadProfile().catch(() => {
    const el = document.getElementById("profileInfo");
    if (el) el.textContent = "Profile loading requires /api/me (backend).";
  });

  // Default tab (optional)
  show("posts");
</script>
</body>
</html>